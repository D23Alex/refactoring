# refactoring

Здравствуйте!
Над этим проектом мы будем работать в рамках первого сценария курса "Рефакторинг баз данных и приложений". Название - Scorekeeper.

Scorekeeper - это система, позволяющая небольшим баскетбольным лигам вести учет своих команд, игроков, контрактов и персонала, а также проводить мониторинг и анализ статистики матчей.
Цель - создать приложение, способное автоматизировать работу спортивной лиги. Для того, чтобы дать общие предстваления, расскажу о наших потенциальных пользователях.

В нашем приложении будут существовать три основные роли: Секретарь матча, административный работник лиги и пользователь.
Секретарь матча - человек, присутствующий на игре и занимающийся ведением статистики матча в реальном времени. Всё, что произошло на матче и что позволяет задокументировать приложение, должно быть им задокументировано в срок.
Административный работник - человек, который вносит и поддерживает в актуальном виде информацию о командах, игроках, контрактах, аренах, инфраструктуре клуба и проч.
Пользователь - человек, интересующийся статистикой своих любимых команд и игроков.

Принято решение делить приложение на сервисы по принципу "1 роль - 1 сервис".

Что будет изменяться от итерации к итерации?
Сложность статистических показателей - от "Кто победил?" до "Как часто игрок, задействованный за сезон более чем в двух, но не более чем в пяти командах, совершает в третьей четверти матча три передачи и два перехвата в течении 2 минут после выхода со скамейки запасных, при этом имея рядом сокомандников, набирающих не более 10 очков за матч в среднем на протяжении сезона?"
Сложность аналитики - от "посчитай процент побед команды A против команды B" до "Скажи, какому игроку дать контракт, кого выпустить на поле, кого уволить?".
Точность ведения статистики - от "Считаем сколько очков у команды X" до "Запоминаем каждое действие каждого игрока и каждого тренера".
Мы предполагаем, что, варьируя на каждом из этапов эти параметры, сможем сконструировать (при помощи преподавателя и по его же указаниям) себе требования сложные настолько, чтобы временные и ресурсные затраты на их реализацию были справедливы для курса "Рефакторинг баз данныхи приложений". Конечно, на этих трёх вещах функциональность не заканчивается, однако для того, чтобы дать вам, уважаемый читатель, поверхностное представление о решаемых задачах, эти три пункта подходят более всего.

Курс предполагает деление процесса разработки проекта на 3 этапа, конечный продукт каждого из которых я попытаюсь описать ниже.
Этап 1. На первом этапе будут созданы 3 сервиса, описанные ранее. Первый сервис - League Manager - служит для crud операция над игроками, сезонами, играми, командами и т.д, составления расписания игр на сезон, управления контрактами игроков и их переходами между клубами. Используется БД Postgres. Второй сервис - Scorekeeper - служит для мониторинга и управления протоколами результативности матчей. Вызывает первый сервис. Использует Mongo для хранения протоколов результативности игр. Используется update in place подход, то есть новая информация в протоколе безвозвратно удаляет старую. Третий сервис - Stats. Его задача - анализировать протоколы результативности и на их основе генерировать статистические показатели (например, точность попаданий, среднее число любых полезных действий игрока/команды/лиги в сезоне/игре и другие вещи). Продвинутой статистики пока нет, для неё нужны фичи в других сервисах (логирование событий, см. этап 2). Вызывает 2 сервис. Использует Caffeine кэш.

Этап  2 (Мы здесь). Легенда второго этапа такова: заказчик даёт понять, что в будущем необходима продвинутая статистика. В связи с этим обыкновенный подход, где секретарь просто вносит изменения в таблицы результативности оказывается более не применимым. В наше приложение приходит архитектурный паттерн event sourcing. теперь секретарь ничего не изменяет, но каждые несколько секунд документирует какое-то произошедшее на площадке событие. А состояние (в нашем случае - статистические таблицы) более не хранится в БД сервиса ведения статистики, а рассчитывается как функция от некоторого числа событий. Для того, чтобы это реализовать, придётся провести масштабный рефакторинг БД (как минимум БД сервиса для ведения статистики). Кроме того, теперь в наше приложение раз и навсегда приходит такое понятие, как время, ведь напротив каждого события стоит временная отметка. Это новое для нашего приложения поняте - ключ, открывающий дверь в дремучее царство продвинутой статистики. На этом этапе реализуются самые важные статистические показатели из числа продвинутых (то есть таких, что не записываются в протокол, а вычисляются по формулам).

Этап 3, и последний. Больше разных игровых событий. Больше продвинутой статистики. Добавление кэширования для 2 сервиса. Больше алгоритмов кэширования для 3 сервиса. Рефакторинг кода. Решение всех тех проблем, что непременно должны возникнуть в ходе этапов 1 и 2, но о которых мы пока не знаем.

Студенты группы P34111 Университета ИТМО Алексей Дорморезов и Чесноков Аркадий. telegram: @dormorezov, @nokkov.
