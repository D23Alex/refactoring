# refactoring

Здравствуйте!
Над этим проектом мы будем работать в рамках первого сценария курса "Рефакторинг баз данных и приложений". Кодовое название проекта на данном этапе - Scorekeeper.

Scorekeeper - это система, позволяющая небольшим баскетбольным лигам вести учет своих команд, игроков, контрактов и персонала, а также проводить мониторинг и анализ статистики матчей.
Цель - создать приложение, способное автоматизировать работу спортивной лиги. Для того, чтобы дать общие предстваления, расскажу о наших потенциальных пользователях.

В нашем приложении будут существовать четыре основные роли: Секретарь матча, административный работник лиги, сотрудник клуба и пользователь.
Секретарь матча - человек, присутствующий на игре и занимающийся ведением статистики матча в реальном времени. Всё, что произошло на матче и что позволяет задокументировать приложение, должно быть им задокументировано в срок.
Административный работник - человек, который вносит и поддерживает в актуальном виде информацию о командах, игроках, контрактах, аренах, инфраструктуре клуба и проч.
Сотрудник клуба - потребитель продвинутой статистики, предсказаний и советов создаваемой системы относительно действий, которые могут привести к повышению эффективности команды в лиге.
Пользователь - человек, интересующийся статистикой своих любимых команд и игроков.

Что будет изменяться от итерации к итерации?
Сложность статистических показателей - от "Кто победил?" до "Как часто игрок, задействованный за сезон более чем в двух, но не более чем в пяти командах, совершает в третьей четверти матча три передачи и два перехвата в течении 2 минут после выхода со скамейки запасных, при этом имея рядом сокомандников, набирающих не более 10 очков за матч в среднем на протяжении сезона?"
Сложность аналитики - от "посчитай процент побед команды A против команды B" до "Скажи, какому игроку дать контракт, кого выпустить на поле, кого уволить?".
Точность ведения статистики - от "Считаем сколько очков у команды X" до "Запоминаем каждое действие каждого игрока и каждого тренера".
Мы предполагаем, что, варьируя на каждом из этапов эти параметры, сможем сконструировать (при помощи преподавателя и по его же указаниям) себе требования сложные настолько, чтобы временные и ресурсные затраты на их реализацию были справедливы для курса "Рефакторинг баз данныхи приложений". Конечно, на этих трёх вещах функциональность не заканчивается, однако для того, чтобы дать вам, уважаемый читатель, поверхностное представление о решаемых задачах, эти три пункта подходят более всего.

Курс предполагает деление процесса разработки проекта на 3 этапа, конечный продукт каждого из которых я попытаюсь описать ниже.
Этап 1. На первом этапе будет создано приложение, реализующее в основном CRUD операции, такие так: создание и редактирование информации о командах, игроках и сотрудниках; редактирование статистики игроков за матч, сезон или даже некий произвольный период; генерация статистических таблиц для игрока/команды/лиги за матч/сезон/некий период (предположительно в формате json) на основе внесенных секретарями данных. Ведение статистики - на уровне "кто победил" и "кто сколько забил", аналитика пока что не предусмотрена. На этом этапе используется update in place подход (то есть новая информация заменяет старую, а та в свою очередь исчезает бесследно). Уже существуют две из четырёх ролей, описанных выше. Решение состоит из двух связанных компонентов - сервис для ведения учёта игроков, сотрудников, команд и организации матчей, которым пользуются административные работники, а также сервис для ведения статистики, которым пользуются присутствующие на матчах секретари.

Этап 2. Легенда второго этапа такова: заказчик даёт понять, что в будущем необходима продвинутая статистика. В связи с этим обыкновенный подход, где секретарь просто вносит изменения в таблицы результативности оказывается более не применимым. В наше приложение приходит архитектурный паттерн event sourcing. теперь секретарь ничего не изменяет, но каждые несколько секунд документирует какое-то произошедшее на площадке событие. А состояние (в нашем случае - статистические таблицы) более не хранится в БД сервиса ведения статистики, а рассчитывается как функция от некоторого числа событий. Для того, чтобы это реализовать, придётся провести масштабный рефакторинг БД (как минимум БД сервиса для ведения статистики). Кроме того, теперь в наше приложение раз и навсегда приходит такое понятие, как время, ведь напротив каждого события стоит временная отметка. Это новое для нашего приложения поняте - ключ, открывающий дверь в дремучее царство продвинутой статистики. На этом этапе реализуются самые важные статистические показатели из числа продвинутых (то есть таких, что не записываются в протокол, а вычисляются по формулам).

Этап 3, и последний. Тут тоже немало дел. Во-первых, стоит задуматься о производительности. Event sourcing предполагает необходимость кеширования (или, как правильнее сказать в данном случае, создания снапшотов). Нужно продумать, при каких условиях они будут создаваться, а также как долго, где и в каком виде они будут храниться. Приведя производительность в порядок, можно задуматься о сервисе, занимающемся аналитикой. Вернее о двух сервисах - один для сотрудников клуба, другой для обычных фанатов. Задача последнего - выдавать статистику в том же виде, что и раньше, только теперь продвинутую и сложную. Задача первого - выдывать на основе имеющейся статистики советы для сотрудников клубов. Если преподаватель сочтёт необходимым увеличить сложность третьего этапа, мы можем добавить клиент для секретаря (хотя бы cli), логирование (тут можно использовать k/v БД или что-то отличное от Postgres) и проч.

Скоро здесь появится список требований и user stories.

Благодарю за внимание. С уважением, студенты группы P34111 Университета ИТМО Алексей Дорморезов и Чесноков Аркадий. telegram: @dormorezov, @nokkov.
