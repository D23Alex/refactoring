# refactoring

Здравствуйте!
Над этим проектом мы будем работать в рамках первого сценария курса "Рефакторинг баз данных и приложений". Название - Scorekeeper.

Scorekeeper - это система, позволяющая небольшим баскетбольным лигам вести учет своих команд, игроков, контрактов и персонала, а также проводить мониторинг и анализ статистики матчей.
Цель - создать приложение, способное автоматизировать работу спортивной лиги. Для того, чтобы дать общие предстваления, расскажу о наших потенциальных пользователях.

В нашем приложении будут существовать три основные роли: Секретарь матча, административный работник лиги и пользователь.
Секретарь матча - человек, присутствующий на игре и занимающийся ведением статистики матча в реальном времени. Всё, что произошло на матче и что позволяет задокументировать приложение, должно быть им задокументировано в срок.
Административный работник - человек, который вносит и поддерживает в актуальном виде информацию о командах, игроках, контрактах, аренах, инфраструктуре клуба и проч.
Пользователь - человек, интересующийся статистикой своих любимых команд и игроков.

Принято решение делить приложение на сервисы по принципу "1 роль - 1 сервис".

Курс предполагает деление процесса разработки проекта на 3 этапа, конечный продукт каждого из которых я попытаюсь описать ниже.

### Этап 1
На первом этапе будут созданы 3 сервиса, описанные ранее. Первый сервис - League Manager - служит для crud операция над игроками, сезонами, играми, командами и т.д, составления расписания игр на сезон, управления контрактами игроков и их переходами между клубами. Используется БД Postgres. Второй сервис - Scorekeeper - служит для мониторинга и управления протоколами результативности матчей. Вызывает первый сервис. Использует Mongo для хранения протоколов результативности игр. Используется update in place подход, то есть новая информация в протоколе безвозвратно удаляет старую. Третий сервис - Stats. Его задача - анализировать протоколы результативности и на их основе генерировать статистические показатели (например, точность попаданий, среднее число любых полезных действий игрока/команды/лиги в сезоне/игре и другие вещи). Продвинутой статистики пока нет, для неё нужны фичи в других сервисах (логирование событий, см. этап 2). Вызывает 2 сервис. Использует Caffeine кэш.

### Этап  2
Легенда второго этапа такова: заказчик даёт понять, что в будущем необходима продвинутая статистика. В связи с этим обыкновенный подход, где секретарь просто вносит изменения в таблицы результативности оказывается более не применимым. В наше приложение приходит архитектурный паттерн event sourcing. теперь секретарь ничего не изменяет, но каждые несколько секунд документирует какое-то произошедшее на площадке событие. А состояние (в нашем случае - статистические таблицы) более не хранится в БД сервиса ведения статистики, а рассчитывается как функция от некоторого числа событий. Для того, чтобы это реализовать, придётся провести масштабный рефакторинг БД (как минимум БД сервиса для ведения статистики). Кроме того, теперь в наше приложение раз и навсегда приходит такое понятие, как время, ведь напротив каждого события стоит временная отметка. Это новое для нашего приложения поняте - ключ, открывающий дверь в дремучее царство продвинутой статистики. На этом этапе реализуются самые важные статистические показатели из числа продвинутых (то есть таких, что не записываются в протокол, а вычисляются по формулам).

### Этап 3, и последний
- Добавление кэширования на втором сервисе (scorekeeper)
- Увеличение кэшируемых расчётов в 3 сервисе (stats)
- Добавление различных видов продвинутой статистики, основанных на функциональности, добавленной в предыдущем этапе
- Добавление возможности отменять события (реализовано в виде т.н. cancel event)
- Разграничение названий url’ов и названий сущностей в БД
- Добавление валидации запросов
- Фикс багов с прошлого этапа
- Рефакторинг кода

На данный момент все 3 этапа выполнены, но, возможно, в будущем мы решим продолжить работу над этим проектом и добавим ещё что-нибудь интересненькое ;)

Студенты группы P34111 Университета ИТМО Алексей Дорморезов и Чесноков Аркадий. telegram: @dormorezov, @nokkov.
